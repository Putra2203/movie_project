generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  email              String            @unique
  createdAt          DateTime          @default(now()) @map("created_at")
  profilePicture     String?
  role               String            @default("user")
  username           String?           @unique
  id                 String            @id @default(uuid()) @map("id") @db.Uuid
  last_email_sent_at DateTime?
  comments           Comment[]
  SavedWatchlist     SavedWatchlist[]
  watchedMovies      WatchedMovie[]
  favoriteMovies     favoriteMovie[]
  members            watchlistMember[]
}

model Movie {
  id             Int             @id @default(autoincrement())
  title          String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  overview       String          @default("")
  genres         String[]
  backdropPath   String?
  certification  String?
  releaseDates   String?
  runtime        Int?
  cast           Json?
  companyNames   String[]
  writers        String[]
  directors      String[]
  movieTrailer   Json?
  tmdbId         String          @unique
  posterPath     String?         @map("poster_path")
  vote_average   Int?
  comments       Comment[]
  watchedMovies  WatchedMovie[]
  watchlistItems WatchlistItem[]
  favoriteMovies favoriteMovie[]
}

model Watchlist {
  id             Int               @id @default(autoincrement())
  createdAt      DateTime          @default(now())
  description    String?
  name           String
  picture        String?
  updatedAt      DateTime          @updatedAt
  inviteToken    String?           @unique
  isPublic       Boolean           @default(true)
  token          String            @unique
  SavedWatchlist SavedWatchlist[]
  items          WatchlistItem[]
  members        watchlistMember[]
}

model watchlistMember {
  id          Int        @id @default(autoincrement())
  userId      String     @db.Uuid
  watchlistId Int
  role        MemberRole @default(COLLABORATOR)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  watchlist   Watchlist  @relation(fields: [watchlistId], references: [id], onDelete: Cascade)

  @@unique([userId, watchlistId])
  @@index([watchlistId])
  @@index([userId])
}

model WatchlistItem {
  id          Int       @id @default(autoincrement())
  watchlistId Int
  movieId     Int
  addedAt     DateTime  @default(now())
  movie       Movie     @relation(fields: [movieId], references: [id], onDelete: Cascade)
  watchlist   Watchlist @relation(fields: [watchlistId], references: [id], onDelete: Cascade)

  @@unique([watchlistId, movieId])
}

model Comment {
  id        Int      @id @default(autoincrement())
  content   String
  createdAt DateTime @default(now())
  movieId   Int
  updatedAt DateTime @updatedAt
  userId    String   @map("user_id") @db.Uuid
  movie     Movie    @relation(fields: [movieId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentId  Int?      
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")

  @@index([movieId])
  @@index([parentId])
}

model WatchedMovie {
  id        Int      @id @default(autoincrement())
  movieId   Int
  watchedAt DateTime @default(now())
  userId    String   @map("user_id") @db.Uuid
  movie     Movie    @relation(fields: [movieId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, movieId])
  @@index([userId])
  @@index([movieId])
}

model favoriteMovie {
  id        Int      @id @default(autoincrement())
  userId    String   @map("user_id") @db.Uuid
  movieId   Int
  watchedAt DateTime @default(now())
  movie     Movie    @relation(fields: [movieId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, movieId])
  @@index([userId])
  @@index([movieId])
}

model SavedWatchlist {
  id          String    @id @default(cuid())
  userId      String    @map("user_id") @db.Uuid
  watchlistId Int
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id])
  watchlist   Watchlist @relation(fields: [watchlistId], references: [id])

  @@unique([userId, watchlistId])
}

enum MemberRole {
  OWNER
  COLLABORATOR
  VIEWER
}
